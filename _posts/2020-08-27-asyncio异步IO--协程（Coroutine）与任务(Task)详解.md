---
title: asyncio异步IO--协程（Coroutine）与任务(Task)详解
tags: python
---

<div class="post-body" itemprop="articleBody" style="opacity: 1; display: block; transform: translateY(0px); user-select: auto;">

​      
​      


        <p style="user-select: auto;">摘要：本文翻译自<a href="https://docs.python.org/3/library/asyncio-task.html#running-an-asyncio-program" target="_blank" rel="noopener" style="user-select: auto;">Coroutines and Tasks</a>，主要介绍asyncio中用于处理协程和任务的方法和接口。在翻译过程中，译者在官方文档的基础上增加了部分样例代码和示意图表，以帮助读者对文档的理解。本文内容主要针对python3.7，在低版本的python中可能不适用，敬请留意。原创内容，如需转载请注明出处。<br style="user-select: auto;">译者：马鸣谦（邮箱：<a href="mailto:553850687@qq.com" target="_blank" rel="noopener" style="user-select: auto;">553850687@qq.com</a>）</p>
<h2 id="协程" style="user-select: auto;"><a href="#协程" class="headerlink" title="协程" style="user-select: auto;"></a>协程</h2><p style="user-select: auto;">协程（coroutines）是通过<code style="user-select: auto;">async/await</code>定义函数或方法，是使用asyncio进行异步编程的首选途径。如下，是一个协程的例子：<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">import</span> asyncio</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">main</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">  print(<span class="string" style="user-select: auto;">"hello"</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">  <span class="keyword" style="user-select: auto;">await</span> asyncio.sleep(<span class="number" style="user-select: auto;">1</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">  print(<span class="string" style="user-select: auto;">"world"</span>)</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<a id="more" style="user-select: auto;"></a>
<p style="user-select: auto;">上例中的 <code style="user-select: auto;">main</code> 方法就是我们定义的<code style="user-select: auto;">协程</code> 。代码的功能很简单：</p>
<p style="user-select: auto;"></p><div id="flowchart-0" class="flow-chart" style="user-select: auto;"><svg height="216" version="1.1" width="323.34375" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="overflow: hidden; position: relative; left: -0.5px; user-select: auto;" viewBox="0 0 323.34375 216" preserveAspectRatio="xMidYMid meet"><desc style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;">Created with Raphaël 2.2.0</desc><defs style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;"><path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;"></path><marker id="raphael-marker-endblock33-obj8hmbe" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;"><use xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;"></use></marker><marker id="raphael-marker-endblock33-obj1agg9" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;"><use xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;"></use></marker><marker id="raphael-marker-endblock33-obj0pfl7" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;"><use xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;"></use></marker><marker id="raphael-marker-endblock33-objx5bra" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;"><use xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;"></use></marker></defs><rect x="0" y="0" width="46" height="34" rx="20" ry="20" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;" stroke-width="2" class="flowchart" id="s" transform="matrix(1,0,0,1,21.8359,4)"></rect><text x="10" y="17" text-anchor="start" font-family="&quot;Arial&quot;" font-size="12px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 12px; user-select: auto;" id="st" class="flowchartt" transform="matrix(1,0,0,1,21.8359,4)" stroke-width="1"><tspan dy="4" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;">开始</tspan></text><rect x="0" y="0" width="78.359375" height="34" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;" stroke-width="2" class="flowchart" id="op1" transform="matrix(1,0,0,1,123.4922,4)"></rect><text x="10" y="17" text-anchor="start" font-family="&quot;Arial&quot;" font-size="12px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 12px; user-select: auto;" id="op1t" class="flowchartt" transform="matrix(1,0,0,1,123.4922,4)" stroke-width="1"><tspan dy="4" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;">打印“hello”</tspan></text><rect x="0" y="0" width="64.6875" height="34" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;" stroke-width="2" class="flowchart" id="op2" transform="matrix(1,0,0,1,130.3281,92)"></rect><text x="10" y="17" text-anchor="start" font-family="&quot;Arial&quot;" font-size="12px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 12px; user-select: auto;" id="op2t" class="flowchartt" transform="matrix(1,0,0,1,130.3281,92)" stroke-width="1"><tspan dy="4" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;">沉睡1秒</tspan></text><rect x="0" y="0" width="81.671875" height="34" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;" stroke-width="2" class="flowchart" id="op3" transform="matrix(1,0,0,1,121.8359,180)"></rect><text x="10" y="17" text-anchor="start" font-family="&quot;Arial&quot;" font-size="12px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 12px; user-select: auto;" id="op3t" class="flowchartt" transform="matrix(1,0,0,1,121.8359,180)" stroke-width="1"><tspan dy="4" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;">打印“world”</tspan></text><rect x="0" y="0" width="46" height="34" rx="20" ry="20" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;" stroke-width="2" class="flowchart" id="e" transform="matrix(1,0,0,1,275.3438,180)"></rect><text x="10" y="17" text-anchor="start" font-family="&quot;Arial&quot;" font-size="12px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: Arial; font-size: 12px; user-select: auto;" id="et" class="flowchartt" transform="matrix(1,0,0,1,275.3438,180)" stroke-width="1"><tspan dy="4" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;">结束</tspan><tspan dy="14.399999999999999" x="10" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;"></tspan></text><path fill="none" stroke="#000000" d="M67.8359375,21C67.8359375,21,108.93949127197266,21,120.49986577033997,21" stroke-width="2" marker-end="url(#raphael-marker-endblock33-obj8hmbe)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;"></path><path fill="none" stroke="#000000" d="M162.671875,38C162.671875,38,162.671875,77.65409994125366,162.671875,89.00043908460066" stroke-width="2" marker-end="url(#raphael-marker-endblock33-obj1agg9)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;"></path><path fill="none" stroke="#000000" d="M162.671875,126C162.671875,126,162.671875,165.65409994125366,162.671875,177.00043908460066" stroke-width="2" marker-end="url(#raphael-marker-endblock33-obj0pfl7)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;"></path><path fill="none" stroke="#000000" d="M203.5078125,197C203.5078125,197,258.7530091702938,197,272.3485067883739,197" stroke-width="2" marker-end="url(#raphael-marker-endblock33-objx5bra)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); user-select: auto;"></path></svg></div><br style="user-select: auto;">我们在交互环境(Python3.7)下执行以上代码，看看效果：<p style="user-select: auto;"></p>
<figure class="highlight bash" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">9</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">10</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">&gt;&gt;&gt; import asyncio</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">&gt;&gt;&gt; async def main():</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">...     <span class="built_in" style="user-select: auto;">print</span>(<span class="string" style="user-select: auto;">"hello"</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">...     await asyncio.sleep(1)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">...     <span class="built_in" style="user-select: auto;">print</span>(<span class="string" style="user-select: auto;">"world"</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">&gt;&gt;&gt; asyncio.run(main())</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">hello</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">world</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure>
<p style="user-select: auto;">需要注意的是：如果像执行普通代码一样直接调用<code style="user-select: auto;">main()</code>，只会返回一个<code style="user-select: auto;">coroutine</code>对象，<code style="user-select: auto;">main()</code>方法内的代码不会执行：<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="meta" style="user-select: auto;">&gt;&gt;&gt; </span>main() <span class="comment" style="user-select: auto;">#直接执行`main()`返回的是一个`coroutine对象`。</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">&lt;coroutine object main at <span class="number" style="user-select: auto;">0x0000000002C97848</span>&gt;</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">实际上，asyncio提供了三种执行<code style="user-select: auto;">协程</code>的机制：</p>
<ol style="user-select: auto;">
<li style="user-select: auto;"><strong style="user-select: auto;">使用<code style="user-select: auto;">asyncio.run()</code>执行协程。一般用于执行最顶层的入口函数，如<code style="user-select: auto;">main()</code>。</strong></li>
<li style="user-select: auto;"><strong style="user-select: auto;"><code style="user-select: auto;">await</code>一个<code style="user-select: auto;">协程</code>。一般用于在一个<code style="user-select: auto;">协程</code>中调用<code style="user-select: auto;">另一协程</code>。</strong> 如下是一个示例：</li>
</ol>
<figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">9</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">10</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">11</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">12</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">13</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">14</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">15</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">16</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">17</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="meta" style="user-select: auto;">&gt;&gt;&gt; </span><span class="keyword" style="user-select: auto;">import</span> time</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="meta" style="user-select: auto;">&gt;&gt;&gt; </span><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">say_after</span><span class="params" style="user-select: auto;">(delay,what)</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">await</span> asyncio.sleep(delay)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        print(what)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="meta" style="user-select: auto;">&gt;&gt;&gt; </span><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">main</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        print(<span class="string" style="user-select: auto;">f"started at <span class="subst" style="user-select: auto;">{time.strftime(<span class="string" style="user-select: auto;">'%X'</span>)}</span>"</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">await</span> say_after(<span class="number" style="user-select: auto;">1</span>,<span class="string" style="user-select: auto;">"hello"</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">await</span> say_after(<span class="number" style="user-select: auto;">2</span>,<span class="string" style="user-select: auto;">"world"</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        print(<span class="string" style="user-select: auto;">f"finished at <span class="subst" style="user-select: auto;">{time.strftime(<span class="string" style="user-select: auto;">'%X'</span>)}</span>"</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="meta" style="user-select: auto;">&gt;&gt;&gt; </span>asyncio.run(main())</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">started at <span class="number" style="user-select: auto;">16</span>:<span class="number" style="user-select: auto;">47</span>:<span class="number" style="user-select: auto;">10</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">hello</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">world</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">finished at <span class="number" style="user-select: auto;">16</span>:<span class="number" style="user-select: auto;">47</span>:<span class="number" style="user-select: auto;">13</span></span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure>
<p style="user-select: auto;">执行耗时 <strong style="user-select: auto;">3秒</strong></p>
<ol start="3" style="user-select: auto;">
<li style="user-select: auto;"><strong style="user-select: auto;">用<code style="user-select: auto;">asyncio.create_task()</code>方法将<code style="user-select: auto;">Coroutine（协程）</code>封装为<code style="user-select: auto;">Task（任务）</code>。一般用于实现异步并发操作。</strong> 需要注意的是，只有在当前线程存在事件循环的时候才能创建任务（Task）。</li>
</ol>
<p style="user-select: auto;">我们修改以上的例程，<strong style="user-select: auto;">并发执行</strong> 两个<code style="user-select: auto;">say_after</code>协程。<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">main</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    task1 = asyncio.create_task(say_after(<span class="number" style="user-select: auto;">1</span>,<span class="string" style="user-select: auto;">"hello"</span>))</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    task2 = asyncio.create_task(say_after(<span class="number" style="user-select: auto;">2</span>,<span class="string" style="user-select: auto;">"world"</span>))</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    print(<span class="string" style="user-select: auto;">f"started at <span class="subst" style="user-select: auto;">{time.strftime(<span class="string" style="user-select: auto;">'%X'</span>)}</span>"</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">await</span> task1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">await</span> task2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    print(<span class="string" style="user-select: auto;">f"finished at <span class="subst" style="user-select: auto;">{time.strftime(<span class="string" style="user-select: auto;">'%X'</span>)}</span>"</span>)</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">执行<code style="user-select: auto;">asyncio.run(main())</code>,结果如下：<br style="user-select: auto;"></p><figure class="highlight plain" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">started at 17:01:34</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">hello</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">world</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">finished at 17:01:36</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;"><strong style="user-select: auto;">耗时2秒</strong></p>
<h2 id="“可等待”对象（Awaitables）" style="user-select: auto;"><a href="#“可等待”对象（Awaitables）" class="headerlink" title="“可等待”对象（Awaitables）" style="user-select: auto;"></a>“可等待”对象（Awaitables）</h2><p style="user-select: auto;">如果一个对象能够被用在<code style="user-select: auto;">await</code>表达式中，那么我们称这个对象是<code style="user-select: auto;">可等待对象（awaitable object）</code>。很多<code style="user-select: auto;">asyncio API</code>都被设计成了<code style="user-select: auto;">可等待的</code>。<br style="user-select: auto;">主要有三类<strong style="user-select: auto;">可等待</strong>对象：</p>
<ul style="user-select: auto;">
<li style="user-select: auto;">协程<code style="user-select: auto;">coroutine</code></li>
<li style="user-select: auto;">任务<code style="user-select: auto;">Task</code></li>
<li style="user-select: auto;">未来对象<code style="user-select: auto;">Future</code>。</li>
</ul>
<h3 id="Coroutine（协程）" style="user-select: auto;"><a href="#Coroutine（协程）" class="headerlink" title="Coroutine（协程）" style="user-select: auto;"></a>Coroutine（协程）</h3><p style="user-select: auto;">Python的<code style="user-select: auto;">协程</code>是<code style="user-select: auto;">可等待的（awaitable）</code>，因此能够被其他<code style="user-select: auto;">协程</code>用在<code style="user-select: auto;">await</code>表达式中。<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">9</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">10</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">11</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">12</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">13</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">14</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">15</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">import</span> asyncio</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">nested</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    print(<span class="string" style="user-select: auto;">"something"</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">main</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;"># 如果直接调用 "nested()"，什么都不会发生.</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;"># 直接调用的时候只是创建了一个 协程对象 ，但这个对象没有被 await,</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;"># 所以它并不会执行.</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    nested()</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;"># 那么我们 await 这个协程，看看会是什么结果:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">await</span> nested()  <span class="comment" style="user-select: auto;"># 将会打印 "something".</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">asyncio.run(main())</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;"><strong style="user-select: auto;">重要</strong>：在这篇文章中，术语<code style="user-select: auto;">coroutine</code>或<code style="user-select: auto;">协程</code>指代两个关系紧密的概念：</p>
<ul style="user-select: auto;">
<li style="user-select: auto;"><code style="user-select: auto;">协程函数（coroutine function）</code>:由<code style="user-select: auto;">async def</code>定义的函数；</li>
<li style="user-select: auto;"><code style="user-select: auto;">协程对象（coroutine object）</code>：调用 <code style="user-select: auto;">协程函数</code>返回的对象。</li>
</ul>
<p style="user-select: auto;">asyncio也支持传统的基于生成器的协程。</p>
<h3 id="Task（任务）" style="user-select: auto;"><a href="#Task（任务）" class="headerlink" title="Task（任务）" style="user-select: auto;"></a>Task（任务）</h3><p style="user-select: auto;"><code style="user-select: auto;">Task</code>用来 <strong style="user-select: auto;">并发的</strong> 调度协程。<br style="user-select: auto;">当一个<code style="user-select: auto;">协程</code>通过类似 <code style="user-select: auto;">asyncio.create_task()</code> 的函数被封装进一个 <code style="user-select: auto;">Task</code>时，这个<code style="user-select: auto;">协程</code> 会很快被自动调度执行：<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">9</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">10</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">11</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">12</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">13</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">14</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">15</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">import</span> asyncio</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">nested</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">return</span> <span class="number" style="user-select: auto;">42</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">main</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;"># Schedule nested() to run soon concurrently</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;"># with "main()".</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    task = asyncio.create_task(nested())</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;"># "task" can now be used to cancel "nested()", or</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;"># can simply be awaited to wait until it is complete:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">await</span> task</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">asyncio.run(main())</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<h3 id="Future（未来对象）" style="user-select: auto;"><a href="#Future（未来对象）" class="headerlink" title="Future（未来对象）" style="user-select: auto;"></a>Future（未来对象）</h3><p style="user-select: auto;"><code style="user-select: auto;">Future</code> 是一种特殊的 <strong style="user-select: auto;">底层</strong> 可等待对象，代表一个异步操作的<strong style="user-select: auto;">最终结果</strong>。<br style="user-select: auto;">当一个<code style="user-select: auto;">Future</code>对象被<code style="user-select: auto;">await</code>的时候，表示当前的协程会持续等待，直到 <code style="user-select: auto;">Future</code>对象所指向的异步操作执行完毕。<br style="user-select: auto;">在asyncio中，<code style="user-select: auto;">Future</code>对象能使<strong style="user-select: auto;">基于回调</strong>的代码被用于<code style="user-select: auto;">asyn/await</code>表达式中。<br style="user-select: auto;"><strong style="user-select: auto;">一般情况下</strong>，在应用层编程中，<strong style="user-select: auto;">没有必要</strong> 创建<code style="user-select: auto;">Future</code>对象。<br style="user-select: auto;">有时候，有些<code style="user-select: auto;">Future</code>对象会被一些库和asyncio API暴露出来，我们可以<code style="user-select: auto;">await</code>它们：<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">main</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">await</span> function_that_returns_a_future_object()</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;"># this is also valid:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">await</span> asyncio.gather(</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        function_that_returns_a_future_object(),</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        some_python_coroutine()</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    )</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">底层函数返回<code style="user-select: auto;">Future</code>对象的一个例子是：<a href="https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.loop.run_in_executor" target="_blank" rel="noopener" style="user-select: auto;">loop.run_in_executor</a></p>
<h2 id="执行asyncio程序" style="user-select: auto;"><a href="#执行asyncio程序" class="headerlink" title="执行asyncio程序" style="user-select: auto;"></a>执行asyncio程序</h2><figure class="highlight plain" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">asyncio.run(coro, * , debug=False)</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure>
<p style="user-select: auto;">这个函数运行<code style="user-select: auto;">coro</code>参数指定的 <code style="user-select: auto;">协程</code>，负责 <strong style="user-select: auto;">管理asyncio事件循环</strong> ， <strong style="user-select: auto;">终止异步生成器</strong>。<br style="user-select: auto;">在同一个线程中，当已经有asyncio事件循环在执行时，不能调用此函数。<br style="user-select: auto;">如果<code style="user-select: auto;">debug=True</code>，事件循环将运行在 <strong style="user-select: auto;">调试模式</strong>。<br style="user-select: auto;">此函数总是创建一个新的事件循环，并在最后关闭它。建议将它用作asyncio程序的主入口，并且只调用一次。<br style="user-select: auto;"><em style="user-select: auto;">Python3.7新增</em><br style="user-select: auto;"><strong style="user-select: auto;">重要</strong>：这个函数是在Python3.7被临时添加到asyncio中的。</p>
<h2 id="创建Task" style="user-select: auto;"><a href="#创建Task" class="headerlink" title="创建Task" style="user-select: auto;"></a>创建Task</h2><figure class="highlight plain" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">asyncio.create_task(coro)</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure>
<p style="user-select: auto;">将<code style="user-select: auto;">coro</code>参数指定的<code style="user-select: auto;">协程（coroutine）</code>封装到一个<code style="user-select: auto;">Task</code>中，并调度执行。返回值是一个<code style="user-select: auto;">Task</code>对象。<br style="user-select: auto;">任务在由<a href="https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.get_running_loop" target="_blank" rel="noopener" style="user-select: auto;"><code style="user-select: auto;">get_running_loop()</code></a>返回的事件循环（loop）中执行。如果当前线程中没有正在运行的事件循环，将会引发<a href="https://docs.python.org/3/library/exceptions.html#RuntimeError" target="_blank" rel="noopener" style="user-select: auto;"><code style="user-select: auto;">RuntimeError</code></a>异常:<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">import</span> asyncio</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">coro_1</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    print(<span class="string" style="user-select: auto;">"do somthing"</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">task = asyncio.create_task(coro_1())</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">因为当前线程中没有正运行的事件循环，所以引发异常：<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">Traceback (most recent call last):</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">  File <span class="string" style="user-select: auto;">"C:\Program Files\Python37\lib\site-packages\IPython\core\interactiveshell.py"</span>, line <span class="number" style="user-select: auto;">3265</span>, <span class="keyword" style="user-select: auto;">in</span> run_code</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    exec(code_obj, self.user_global_ns, self.user_ns)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">  File <span class="string" style="user-select: auto;">"&lt;ipython-input-4-456c15a4ed16&gt;"</span>, line <span class="number" style="user-select: auto;">1</span>, <span class="keyword" style="user-select: auto;">in</span> &lt;module&gt;</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    task = asyncio.create_task(coro_1())</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">  File <span class="string" style="user-select: auto;">"C:\Program Files\Python37\lib\asyncio\tasks.py"</span>, line <span class="number" style="user-select: auto;">324</span>, <span class="keyword" style="user-select: auto;">in</span> create_task</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    loop = events.get_running_loop()</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">RuntimeError: no running event loop</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">对以上代码稍作修改，创建<code style="user-select: auto;">main()</code>方法，在其中创建<code style="user-select: auto;">Task</code>对象，然后在主程序中利用<code style="user-select: auto;">asyncio.run()</code>创建<code style="user-select: auto;">事件循环</code>：<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">9</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">import</span> asyncio</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">coro</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    print(<span class="string" style="user-select: auto;">"something is running"</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">main</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    task = asyncio.create_task(coro())</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    print(asyncio.get_running_loop())   </span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">asyncio.run(main())</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">执行结果如下：<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">&lt;_WindowsSelectorEventLoop running=<span class="keyword" style="user-select: auto;">True</span> closed=<span class="keyword" style="user-select: auto;">False</span> debug=<span class="keyword" style="user-select: auto;">False</span>&gt;</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">something <span class="keyword" style="user-select: auto;">is</span> running</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">`</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">此函数已经被引入到Python3.7。在Python早期版本中，可以使用底层函数<code style="user-select: auto;">asyncio.ensure_future()</code>代替。<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">9</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">10</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">coro</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    ...</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;"># In Python 3.7+</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">task = asyncio.create_task(coro())</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">...</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;"># This works in all Python versions but is less readable</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">task = asyncio.ensure_future(coro())</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">...</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;"><em style="user-select: auto;">Python3.7新增</em></p>
<h2 id="Sleeping" style="user-select: auto;"><a href="#Sleeping" class="headerlink" title="Sleeping" style="user-select: auto;"></a>Sleeping</h2><pre style="user-select: auto;"><code style="user-select: auto;">coroutine asyncio.sleep(delay,result=None,* ,loop=None)
</code></pre><p style="user-select: auto;">阻塞<code style="user-select: auto;">delay</code>秒，例如<code style="user-select: auto;">delay=3</code>，则阻塞3秒。<br style="user-select: auto;">如果指定了<code style="user-select: auto;">result</code>参数的<code style="user-select: auto;">值</code>，则在协程结束时，将该<code style="user-select: auto;">值</code>返回给调用者。<br style="user-select: auto;"><code style="user-select: auto;">sleep()</code>通常只暂停当前<code style="user-select: auto;">task</code>，并不影响其他<code style="user-select: auto;">task</code>的执行。<br style="user-select: auto;">不建议使用<code style="user-select: auto;">loop</code>参数，因为Python计划在<code style="user-select: auto;">3.10</code>版本中移除它。<br style="user-select: auto;">以下是一个协程的例子，功能是<code style="user-select: auto;">在5秒钟内，每秒显示一次当前的日期</code>：<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">9</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">10</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">11</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">12</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">import</span> asyncio</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">import</span> datetime</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">display_date</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    loop = asyncio.get_running_loop()</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    end_time = loop.time() + <span class="number" style="user-select: auto;">5.0</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">while</span> <span class="keyword" style="user-select: auto;">True</span>:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        print(datetime.datetime.now())</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">if</span> (loop.time() + <span class="number" style="user-select: auto;">1.0</span>) &gt;= end_time:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">            <span class="keyword" style="user-select: auto;">break</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">await</span> asyncio.sleep(<span class="number" style="user-select: auto;">1</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">asyncio.run(display_date())</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">执行结果大致如下：<br style="user-select: auto;"></p><figure class="highlight plain" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">2018-11-20 11:27:15.961830</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2018-11-20 11:27:16.961887</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2018-11-20 11:27:17.961944</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2018-11-20 11:27:18.962001</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2018-11-20 11:27:19.962059</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2018-11-20 11:27:20.962116</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<h2 id="并发执行Tasks" style="user-select: auto;"><a href="#并发执行Tasks" class="headerlink" title="并发执行Tasks" style="user-select: auto;"></a>并发执行Tasks</h2><pre style="user-select: auto;"><code style="user-select: auto;">awaitable asyncio.gather(* aws, loop=None, return_exceptions=False)
</code></pre><p style="user-select: auto;">并发执行<code style="user-select: auto;">aws</code>参数指定的 <code style="user-select: auto;">可等待（awaitable）对象</code>序列。<br style="user-select: auto;">如果 <code style="user-select: auto;">aws</code> 序列中的某个 <code style="user-select: auto;">awaitable 对象</code> 是一个 <code style="user-select: auto;">协程</code>,则自动将这个 <code style="user-select: auto;">协程</code> 封装为 <code style="user-select: auto;">Task</code>对象进行处理。例如：<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">9</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">10</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">11</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">12</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">13</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">14</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">15</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">16</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">17</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">18</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">19</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">20</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">21</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">22</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">23</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">24</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">25</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">26</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">27</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">28</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">29</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">30</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">31</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">import</span> asyncio</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">factorial</span><span class="params" style="user-select: auto;">(name, number)</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    f = <span class="number" style="user-select: auto;">1</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">for</span> i <span class="keyword" style="user-select: auto;">in</span> range(<span class="number" style="user-select: auto;">2</span>, number + <span class="number" style="user-select: auto;">1</span>):</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        print(<span class="string" style="user-select: auto;">f"Task <span class="subst" style="user-select: auto;">{name}</span>: Compute factorial(<span class="subst" style="user-select: auto;">{i}</span>)..."</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">await</span> asyncio.sleep(<span class="number" style="user-select: auto;">1</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        f *= i</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    print(<span class="string" style="user-select: auto;">f"Task <span class="subst" style="user-select: auto;">{name}</span>: factorial(<span class="subst" style="user-select: auto;">{number}</span>) = <span class="subst" style="user-select: auto;">{f}</span>"</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">main</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;"># Schedule three calls *concurrently*:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">await</span> asyncio.gather(</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        factorial(<span class="string" style="user-select: auto;">"A"</span>, <span class="number" style="user-select: auto;">2</span>),</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        factorial(<span class="string" style="user-select: auto;">"B"</span>, <span class="number" style="user-select: auto;">3</span>),</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        factorial(<span class="string" style="user-select: auto;">"C"</span>, <span class="number" style="user-select: auto;">4</span>),</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    )</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">asyncio.run(main())</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;"># Expected output:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;">#</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;">#     Task A: Compute factorial(2)...</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;">#     Task B: Compute factorial(2)...</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;">#     Task C: Compute factorial(2)...</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;">#     Task A: factorial(2) = 2</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;">#     Task B: Compute factorial(3)...</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;">#     Task C: Compute factorial(3)...</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;">#     Task B: factorial(3) = 6</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;">#     Task C: Compute factorial(4)...</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;">#     Task C: factorial(4) = 24</span></span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">如果所有的<code style="user-select: auto;">awaitable</code>对象都执行完毕，则返回 <strong style="user-select: auto;">awaitable对象执行结果的聚合列表</strong>。返回值的顺序于<code style="user-select: auto;">aws</code>参数的顺序一致。<br style="user-select: auto;">简单修改以上代码：<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">9</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">10</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">11</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">12</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">13</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">14</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">15</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">16</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">17</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">18</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">19</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">20</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">21</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">22</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">23</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">24</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">25</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">26</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">import</span> asyncio</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">factorial</span><span class="params" style="user-select: auto;">(name, number)</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    f = <span class="number" style="user-select: auto;">1</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">for</span> i <span class="keyword" style="user-select: auto;">in</span> range(<span class="number" style="user-select: auto;">2</span>, number + <span class="number" style="user-select: auto;">1</span>):</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="comment" style="user-select: auto;">#print(f"Task {name}: Compute factorial({i})...")</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">await</span> asyncio.sleep(<span class="number" style="user-select: auto;">1</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        f *= i</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;">#print(f"Task {name}: factorial({number}) = {f}")</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">return</span> number</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">main</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;"># Schedule three calls *concurrently*:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    print(<span class="keyword" style="user-select: auto;">await</span> asyncio.gather(</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        factorial(<span class="string" style="user-select: auto;">"A"</span>, <span class="number" style="user-select: auto;">2</span>),</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        factorial(<span class="string" style="user-select: auto;">"B"</span>, <span class="number" style="user-select: auto;">3</span>),</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        factorial(<span class="string" style="user-select: auto;">"C"</span>, <span class="number" style="user-select: auto;">4</span>),</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    ))</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">asyncio.run(main())</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;"># Expected output:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;">#</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;">#[2, 3, 4]#await asyncio.gather()的返回值是一个列表，</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;">#分别对应factorial("A", 2),factorial("B", 3),factorial("C", 4)的执行结果。</span></span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">如果<code style="user-select: auto;">return_execptions</code>参数为<code style="user-select: auto;">False</code>（默认值即为<code style="user-select: auto;">False</code>），引发的第一个异常会立即传播给等待<code style="user-select: auto;">gather()</code>的任务，即调用<code style="user-select: auto;">await asyncio.gather()</code>对象。序列中其他<code style="user-select: auto;">awaitable</code>对象的执行不会受影响。例如：<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">9</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">10</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">11</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">12</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">13</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">14</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">15</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">16</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">17</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">18</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">19</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">import</span> asyncio</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">division</span><span class="params" style="user-select: auto;">(divisor, dividend)</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">if</span> divisor == <span class="number" style="user-select: auto;">0</span>:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">raise</span> ZeroDivisionError</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">else</span>:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        print(<span class="string" style="user-select: auto;">f"<span class="subst" style="user-select: auto;">{dividend}</span>/<span class="subst" style="user-select: auto;">{divisor}</span>=<span class="subst" style="user-select: auto;">{dividend/divisor}</span>"</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">return</span> dividend/divisor</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">main</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;"># Schedule three calls *concurrently*:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    print(<span class="keyword" style="user-select: auto;">await</span> asyncio.gather(</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        division(<span class="number" style="user-select: auto;">0</span>, <span class="number" style="user-select: auto;">2</span>),</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        division(<span class="number" style="user-select: auto;">1</span>, <span class="number" style="user-select: auto;">2</span>),</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        division(<span class="number" style="user-select: auto;">2</span>, <span class="number" style="user-select: auto;">2</span>),</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    ))</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">asyncio.run(main())</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">执行结果：<br style="user-select: auto;"></p><figure class="highlight plain" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">9</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">10</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">11</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">12</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">13</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">14</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">2/1=2.0</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2/2=1.0</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">Traceback (most recent call last):</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">  File "test.py", line 19, in &lt;module&gt;</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    asyncio.run(main())</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">  File "c:\Program Files\Python37\lib\asyncio\runners.py", line 43, in run</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    return loop.run_until_complete(main)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">  File "c:\Program Files\Python37\lib\asyncio\base_events.py", line 573, in run_until_complete</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    return future.result()</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">  File "test.py", line 16, in main</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    division(2, 2),</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">  File "test.py", line 6, in division</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    raise ZeroDivisionError</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">ZeroDivisionError</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">如果<code style="user-select: auto;">return_exceptions</code>参数为<code style="user-select: auto;">True</code>，异常会和正常结果一样，被聚合到结果列表中返回。<br style="user-select: auto;">对以上代码稍作修改，将<code style="user-select: auto;">return_exceptions</code>设为<code style="user-select: auto;">True</code>：<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">9</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">10</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">11</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">12</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">13</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">14</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">15</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">16</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">17</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">18</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">19</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">20</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">import</span> asyncio</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">division</span><span class="params" style="user-select: auto;">(divisor, dividend)</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">if</span> divisor == <span class="number" style="user-select: auto;">0</span>:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">raise</span> ZeroDivisionError</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">else</span>:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        print(<span class="string" style="user-select: auto;">f"<span class="subst" style="user-select: auto;">{dividend}</span>/<span class="subst" style="user-select: auto;">{divisor}</span>=<span class="subst" style="user-select: auto;">{dividend/divisor}</span>"</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">return</span> dividend/divisor</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">main</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;"># Schedule three calls *concurrently*:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    print(<span class="keyword" style="user-select: auto;">await</span> asyncio.gather(</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        division(<span class="number" style="user-select: auto;">0</span>, <span class="number" style="user-select: auto;">2</span>),</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        division(<span class="number" style="user-select: auto;">1</span>, <span class="number" style="user-select: auto;">2</span>),</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        division(<span class="number" style="user-select: auto;">2</span>, <span class="number" style="user-select: auto;">2</span>),</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        return_exceptions=<span class="keyword" style="user-select: auto;">True</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    ))</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">asyncio.run(main())</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">执行结果如下：<br style="user-select: auto;"></p><figure class="highlight plain" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">2/1=2.0</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2/2=1.0</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">[ZeroDivisionError(), 2.0, 1.0]#错误不会向上传播，而是作为结果返回</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">如果<code style="user-select: auto;">gather()</code>被取消，则提交的所有<code style="user-select: auto;">awaitable</code>对象（尚未执行完成的）都会被取消。例如：<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">9</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">10</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">11</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">12</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">13</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">14</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">15</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">16</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">17</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">18</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">19</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">20</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">21</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">22</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">23</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">import</span> asyncio</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">division</span><span class="params" style="user-select: auto;">(divisor, dividend)</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">if</span> divisor == <span class="number" style="user-select: auto;">0</span>:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">raise</span> ZeroDivisionError</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">else</span>:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">await</span> asyncio.sleep(divisor)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        print(<span class="string" style="user-select: auto;">f"<span class="subst" style="user-select: auto;">{dividend}</span>/<span class="subst" style="user-select: auto;">{divisor}</span>=<span class="subst" style="user-select: auto;">{dividend/divisor}</span>"</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">return</span> dividend/divisor</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">main</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;"># Schedule three calls *concurrently*:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    t = asyncio.gather(</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        division(<span class="number" style="user-select: auto;">0</span>, <span class="number" style="user-select: auto;">2</span>),</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        division(<span class="number" style="user-select: auto;">1</span>, <span class="number" style="user-select: auto;">5</span>),</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        division(<span class="number" style="user-select: auto;">3</span>, <span class="number" style="user-select: auto;">6</span>),</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        return_exceptions=<span class="keyword" style="user-select: auto;">True</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    )</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">await</span> asyncio.sleep(<span class="number" style="user-select: auto;">2</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    t.cancel()</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">await</span> t</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">asyncio.run(main())</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">执行结果：<br style="user-select: auto;"></p><figure class="highlight plain" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">9</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">10</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">5/1=5.0 #除已执行的之外，其他的任务全部被取消</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">Traceback (most recent call last):</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">  File "test.py", line 23, in &lt;module&gt;</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    asyncio.run(main())</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">  File "c:\Program Files\Python37\lib\asyncio\runners.py", line 43, in run</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    return loop.run_until_complete(main)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">  File "c:\Program Files\Python37\lib\asyncio\base_events.py", line 573, in run_until_complete</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    return future.result()</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">concurrent.futures._base.CancelledError</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">#在return_exceptions=True的情况下，异常依然向上传播。</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">如果<code style="user-select: auto;">aws</code>中某些<code style="user-select: auto;">Task</code>或<code style="user-select: auto;">Future</code>被取消，<code style="user-select: auto;">gather()</code>调用不会被取消，被取消的<code style="user-select: auto;">Task</code>或<code style="user-select: auto;">Future</code>会以引发<code style="user-select: auto;">CancelledError</code>的方式被处理。这样可以避免个别<code style="user-select: auto;">awaitable</code>对象的取消操作影响其他<code style="user-select: auto;">awaitable</code>对象的执行。<br style="user-select: auto;">例如：<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">9</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">10</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">11</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">12</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">13</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">14</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">15</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">16</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">17</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">18</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">19</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">20</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">21</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">22</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">23</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">24</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">25</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">26</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">import</span> asyncio</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">division</span><span class="params" style="user-select: auto;">(divisor, dividend)</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">if</span> divisor == <span class="number" style="user-select: auto;">0</span>:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">raise</span> ZeroDivisionError</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">else</span>:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">await</span> asyncio.sleep(divisor)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        print(<span class="string" style="user-select: auto;">f"<span class="subst" style="user-select: auto;">{dividend}</span>/<span class="subst" style="user-select: auto;">{divisor}</span>=<span class="subst" style="user-select: auto;">{dividend/divisor}</span>"</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">return</span> dividend/divisor</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">main</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;"># Schedule three calls *concurrently*:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    task1 = asyncio.create_task(division(<span class="number" style="user-select: auto;">0</span>, <span class="number" style="user-select: auto;">2</span>))</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    task2 = asyncio.create_task(division(<span class="number" style="user-select: auto;">1</span>, <span class="number" style="user-select: auto;">5</span>))</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    task3 = asyncio.create_task(division(<span class="number" style="user-select: auto;">3</span>, <span class="number" style="user-select: auto;">6</span>))</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    t = asyncio.gather(</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        task1,</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        task2,</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        task3,</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        return_exceptions=<span class="keyword" style="user-select: auto;">True</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    )</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    task1.cancel()</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    print(<span class="keyword" style="user-select: auto;">await</span> t)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">asyncio.run(main())</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">预期执行结果如下：<br style="user-select: auto;"></p><figure class="highlight plain" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">5/1=5.0</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6/3=2.0</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">[CancelledError(), 5.0, 2.0] # 仅task1被取消，其他任务不受影响。</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<h3 id="避免取消" style="user-select: auto;"><a href="#避免取消" class="headerlink" title="避免取消" style="user-select: auto;"></a>避免取消</h3><pre style="user-select: auto;"><code style="user-select: auto;">awaitable asyncio.shield(aw, * , loop=None)
</code></pre><p style="user-select: auto;">防止<code style="user-select: auto;">awaitable</code>对象被<a href="https://docs.python.org/3/library/asyncio-task.html#asyncio.Task.cancel" target="_blank" rel="noopener" style="user-select: auto;">取消(cancelled)</a>执行。<br style="user-select: auto;">如果<code style="user-select: auto;">aw</code>参数是一个<code style="user-select: auto;">协程(coroutines)</code>,该对象会被自动封装为<code style="user-select: auto;">Task</code>对象进行处理。<br style="user-select: auto;">通常，代码：</p>
<pre style="user-select: auto;"><code style="user-select: auto;">#code 1
res = await shield(something())
</code></pre><p style="user-select: auto;">同代码：</p>
<pre style="user-select: auto;"><code style="user-select: auto;">#code 2
res = await something()
</code></pre><p style="user-select: auto;">是等价的。<br style="user-select: auto;">特殊情况是，如果包含以上代码的<code style="user-select: auto;">协程</code>被 <strong style="user-select: auto;">取消</strong>，<code style="user-select: auto;">code 1</code>与<code style="user-select: auto;">code 2</code>的执行效果就完全不同了：</p>
<ul style="user-select: auto;">
<li style="user-select: auto;"><code style="user-select: auto;">code 1</code>中，运行于<code style="user-select: auto;">something()</code>中的任务 <strong style="user-select: auto;">不会被取消</strong>。</li>
<li style="user-select: auto;"><code style="user-select: auto;">code 2</code>中，运行于<code style="user-select: auto;">something()</code>中的任务 <strong style="user-select: auto;">会被取消</strong>。</li>
</ul>
<p style="user-select: auto;">在<code style="user-select: auto;">code 1</code>中，从<code style="user-select: auto;">something()</code>的视角看，取消操作并没有发生。然而，事实上它的调用者确实被取消了，所以<code style="user-select: auto;">await shield(something())</code>仍然会引发一个<code style="user-select: auto;">CancelledError</code>异常。<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">9</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">10</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">11</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">12</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">13</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">14</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">15</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">16</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">17</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">18</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">19</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">20</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">21</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">22</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">23</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">24</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">25</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">import</span> asyncio</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">import</span> time</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">division</span><span class="params" style="user-select: auto;">(divisor, dividend)</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">if</span> divisor == <span class="number" style="user-select: auto;">0</span>:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">raise</span> ZeroDivisionError</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">else</span>:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">await</span> asyncio.sleep(divisor)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        print(<span class="string" style="user-select: auto;">f"<span class="subst" style="user-select: auto;">{time.strftime(<span class="string" style="user-select: auto;">'%X'</span>)}</span>:<span class="subst" style="user-select: auto;">{dividend}</span>/<span class="subst" style="user-select: auto;">{divisor}</span>=<span class="subst" style="user-select: auto;">{dividend/divisor}</span>"</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">return</span> dividend/divisor</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">main</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;"># Schedule three calls *concurrently*:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    print(<span class="string" style="user-select: auto;">f"Start time:<span class="subst" style="user-select: auto;">{time.strftime(<span class="string" style="user-select: auto;">'%X'</span>)}</span>"</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    task1 = asyncio.shield(division(<span class="number" style="user-select: auto;">1</span>, <span class="number" style="user-select: auto;">2</span>))</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    task2 = asyncio.create_task(division(<span class="number" style="user-select: auto;">1</span>, <span class="number" style="user-select: auto;">5</span>))</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    task3 = asyncio.create_task(division(<span class="number" style="user-select: auto;">3</span>, <span class="number" style="user-select: auto;">6</span>))</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    res = asyncio.gather(task1, task2, task3, return_exceptions=<span class="keyword" style="user-select: auto;">True</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    task1.cancel()</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    task2.cancel()</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    print(<span class="keyword" style="user-select: auto;">await</span> res)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">asyncio.run(main())</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">执行结果：<br style="user-select: auto;"></p><figure class="highlight plain" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">Start time:10:38:48</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">10:38:49:2/1=2.0</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">10:38:51:6/3=2.0</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">[CancelledError(), CancelledError(), 2.0]</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">#task1虽然被取消，但是division(1,2)依然正常执行了。</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">#task2被取消后，division(1,5)没有执行</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">#虽然task1内的协程被执行，但返回值依然为CancelledError</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">如果<code style="user-select: auto;">something()</code>以其他的方式被取消，比如从自身内部取消，那么<code style="user-select: auto;">shield()</code>也会被取消。<br style="user-select: auto;">如果希望完全忽略<code style="user-select: auto;">取消操作</code>（不推荐这么做），则可以将<code style="user-select: auto;">shield()</code>与<code style="user-select: auto;">try/except</code>结合起来使用：<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">try</span>:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    res = <span class="keyword" style="user-select: auto;">await</span> shield(something())</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">except</span> CancelledError:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    res = <span class="keyword" style="user-select: auto;">None</span></span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<h2 id="超时（Timeouts）" style="user-select: auto;"><a href="#超时（Timeouts）" class="headerlink" title="超时（Timeouts）" style="user-select: auto;"></a>超时（Timeouts）</h2><figure class="highlight plain" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">coroutine asyncio.wait_for(aw,timeout,*,loop=None)</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure>
<p style="user-select: auto;">在<code style="user-select: auto;">timeout</code>时间之内，等待<code style="user-select: auto;">aw</code>参数指定的<code style="user-select: auto;">awaitable</code>对象执行完毕。<br style="user-select: auto;">如果<code style="user-select: auto;">aw</code>是一个协程，则会被自动作为<code style="user-select: auto;">Task</code>处理。<br style="user-select: auto;"><code style="user-select: auto;">timeout</code>可以是<code style="user-select: auto;">None</code>也可以是一个<code style="user-select: auto;">float</code>或<code style="user-select: auto;">int</code>类型的数字，表示需要等待的秒数。如果<code style="user-select: auto;">timeout</code>是<code style="user-select: auto;">None</code>，则永不超时，一直阻塞到<code style="user-select: auto;">aw</code>执行完毕。<br style="user-select: auto;">如果达到<code style="user-select: auto;">timeout</code>时间，将会取消待执行的任务，引发<code style="user-select: auto;">asyncio.TimeoutError</code>.<br style="user-select: auto;">如果想避免任务被取消，可以将其封装在<code style="user-select: auto;">shield()</code>中。<br style="user-select: auto;">程序会等待到任务确实被取消掉，所以等待的总时间会比<code style="user-select: auto;">timeout</code>略大。<br style="user-select: auto;">如果<code style="user-select: auto;">await_for()</code>被取消，<code style="user-select: auto;">aw</code>也会被取消。<br style="user-select: auto;"><code style="user-select: auto;">loop</code>参数将在Python3.10中删除，所以不推荐使用。<br style="user-select: auto;">示例：<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">9</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">10</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">11</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">12</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">13</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">14</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">15</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">16</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">17</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">eternity</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;"># Sleep for one hour</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">await</span> asyncio.sleep(<span class="number" style="user-select: auto;">3600</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    print(<span class="string" style="user-select: auto;">'yay!'</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">main</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;"># Wait for at most 1 second</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">try</span>:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">await</span> asyncio.wait_for(eternity(), timeout=<span class="number" style="user-select: auto;">1.0</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">except</span> asyncio.TimeoutError:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        print(<span class="string" style="user-select: auto;">'timeout!'</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">asyncio.run(main())</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;"># Expected output:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;">#</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;">#     timeout!</span></span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;"><em style="user-select: auto;">Python3.7新特性</em>：当<code style="user-select: auto;">aw</code>因为超时被取消，<code style="user-select: auto;">wait_for()</code>等到<code style="user-select: auto;">aw</code>确实被取消之后返回异常。在<em style="user-select: auto;">以前的版本中</em>，<code style="user-select: auto;">wait_for</code>会立即返回异常。</p>
<h2 id="等待原语（Waiting-Primitives）" style="user-select: auto;"><a href="#等待原语（Waiting-Primitives）" class="headerlink" title="等待原语（Waiting Primitives）" style="user-select: auto;"></a>等待原语（Waiting Primitives）</h2><h3 id="wait" style="user-select: auto;"><a href="#wait" class="headerlink" title="wait()" style="user-select: auto;"></a>wait()</h3><figure class="highlight plain" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">coroutine asyncio.wait(aws,*,loop=None,timeout=None,return_when=ALL_COMPLETED)</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure>
<p style="user-select: auto;">并发执行<code style="user-select: auto;">aws</code>中的<code style="user-select: auto;">awaitable</code>对象，一直阻塞到<code style="user-select: auto;">return_when</code>指定的情况出现。<br style="user-select: auto;">如果<code style="user-select: auto;">aws</code>中的某些对象是<code style="user-select: auto;">协程（coroutine）</code>，则自动转换为<code style="user-select: auto;">Task</code>对象进行处理。直接将<code style="user-select: auto;">coroutine</code>对象传递给<code style="user-select: auto;">wait()</code>会导致令人迷惑的执行结果，所以不建议这么做。<br style="user-select: auto;">返回值是两个<code style="user-select: auto;">Task/Future</code>集合:(<code style="user-select: auto;">done,pending</code>)。<br style="user-select: auto;">用法示例：<br style="user-select: auto;"></p><figure class="highlight plain" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">done,pending = await asyncio.wait(aws)</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;"><code style="user-select: auto;">loop</code>参数将在Python3.10中删除，所以不建议使用。<br style="user-select: auto;"><code style="user-select: auto;">timeout</code>参数可以是一个<code style="user-select: auto;">int</code>或<code style="user-select: auto;">float</code>类型的值，可以控制最大等待时间。<br style="user-select: auto;">需要注意的是，<code style="user-select: auto;">wait()</code>不会引发<code style="user-select: auto;">asyncio.TimeoutError</code>错误。返回前没有被执行的<code style="user-select: auto;">Future</code>和<code style="user-select: auto;">Task</code>会被简单的放入<code style="user-select: auto;">pending</code>集合。<br style="user-select: auto;"><code style="user-select: auto;">return_when</code>决定函数返回的时机。它只能被设置为以下常量：</p>
<table style="user-select: auto;">
<thead style="user-select: auto;">
<tr style="user-select: auto;">
<th style="user-select: auto;">Constant</th>
<th style="user-select: auto;">Description</th>
</tr>
</thead>
<tbody style="user-select: auto;">
<tr style="user-select: auto;">
<td style="user-select: auto;">FIRST_COMPLETED</td>
<td style="user-select: auto;">The function will return when any future finishes or is cancelled.</td>
</tr>
<tr style="user-select: auto;">
<td style="user-select: auto;">FIRST_EXCEPTION</td>
<td style="user-select: auto;">The function will return when any future finishes by raising an exception. If no future raises an exception then it is equivalent to ALL_COMPLETED.</td>
</tr>
<tr style="user-select: auto;">
<td style="user-select: auto;">ALL_COMPLETED</td>
<td style="user-select: auto;">The function will return when all futures finish or are cancelled.</td>
</tr>
</tbody>
</table>
<p style="user-select: auto;">与<code style="user-select: auto;">wait_for()</code>不同，<code style="user-select: auto;">wait()</code>不会再超时的时候取消任务。<br style="user-select: auto;"><strong style="user-select: auto;">注意：</strong><br style="user-select: auto;">因为<code style="user-select: auto;">wait()</code>会自动将<code style="user-select: auto;">协程</code>转换为<code style="user-select: auto;">Task对象</code>进行处理，然后返回这些隐式创建的<code style="user-select: auto;">Task</code>到（done,pending）集合，所以以下代码不会如预期的那样执行。<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">foo</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">return</span> <span class="number" style="user-select: auto;">42</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">coro = foo()</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">done, pending = <span class="keyword" style="user-select: auto;">await</span> asyncio.wait({coro})</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">if</span> coro <span class="keyword" style="user-select: auto;">in</span> done:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;"># 因为wait()会自动将协程转换为Task对象进行处理，然后返回这些隐式创建的Task到（done,pending）集合，所以这个条件分支永远不会被执行。</span></span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">上面的代码可以做如下修正：<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">foo</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">return</span> <span class="number" style="user-select: auto;">42</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">task = asyncio.create_task(foo())</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">done, pending = <span class="keyword" style="user-select: auto;">await</span> asyncio.wait({task})</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">if</span> task <span class="keyword" style="user-select: auto;">in</span> done:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;"># 这回可以正常执行了.</span></span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">所以，正如上文所讲，不建议将<code style="user-select: auto;">coroutine</code>对象直接传递给<code style="user-select: auto;">wait()</code>。</p>
<h3 id="as-completed" style="user-select: auto;"><a href="#as-completed" class="headerlink" title="as_completed()" style="user-select: auto;"></a>as_completed()</h3><figure class="highlight plain" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">asyncio.as_completed(aws,*,loop=None,timeout=None)</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure>
<p style="user-select: auto;">并发执行<code style="user-select: auto;">aws</code>中的<code style="user-select: auto;">awaitable</code>对象。返回一个<code style="user-select: auto;">Future</code>对象迭代器。每次迭代时返回的<code style="user-select: auto;">Future</code>对象代表待执行的<code style="user-select: auto;">awaitable</code>对象集合里最早出现的结果。<strong style="user-select: auto;">注意</strong>：迭代器返回的顺序与<code style="user-select: auto;">aws</code>列表的顺序无关，只与结果出现的早晚有关。<br style="user-select: auto;">如果超时之前还有<code style="user-select: auto;">Future</code>对象未完成，则引发<code style="user-select: auto;">asyncio.TimeoutError</code>异常。<br style="user-select: auto;">用法示例：<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">for</span> f <span class="keyword" style="user-select: auto;">in</span> as_completed(aws):</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    earliest_result = <span class="keyword" style="user-select: auto;">await</span> f</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;"># ...</span></span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">以下为一个完整的例子：<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">9</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">10</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">11</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">12</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">13</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">14</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">15</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">16</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">import</span> asyncio</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">import</span> time</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">eternity</span><span class="params" style="user-select: auto;">(delay)</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">await</span> asyncio.sleep(delay)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    print(<span class="string" style="user-select: auto;">f"delay for <span class="subst" style="user-select: auto;">{delay}</span> seconds."</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">return</span> delay</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">main</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    print(<span class="string" style="user-select: auto;">f"Start at: <span class="subst" style="user-select: auto;">{time.strftime(<span class="string" style="user-select: auto;">'%X'</span>)}</span>"</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    tasks = [eternity(i) <span class="keyword" style="user-select: auto;">for</span> i <span class="keyword" style="user-select: auto;">in</span> range(<span class="number" style="user-select: auto;">10</span>)]</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">for</span> f <span class="keyword" style="user-select: auto;">in</span> asyncio.as_completed(tasks):</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        res = <span class="keyword" style="user-select: auto;">await</span> f</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    print(<span class="string" style="user-select: auto;">f"End at: <span class="subst" style="user-select: auto;">{time.strftime(<span class="string" style="user-select: auto;">'%X'</span>)}</span>"</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">asyncio.run(main())</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">执行结果如下：<br style="user-select: auto;"></p><figure class="highlight plain" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">9</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">10</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">11</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">12</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">Start at: 17:19:11</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">delay for 0 seconds.</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">delay for 1 seconds.</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">delay for 2 seconds.</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">delay for 3 seconds.</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">delay for 4 seconds.</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">delay for 5 seconds.</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">delay for 6 seconds.</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">delay for 7 seconds.</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">delay for 8 seconds.</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">delay for 9 seconds.</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">End at: 17:19:20</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<h2 id="从其他线程调度执行（Scheduling-From-Other-Threads）" style="user-select: auto;"><a href="#从其他线程调度执行（Scheduling-From-Other-Threads）" class="headerlink" title="从其他线程调度执行（Scheduling From Other Threads）" style="user-select: auto;"></a>从其他线程调度执行（Scheduling From Other Threads）</h2><figure class="highlight plain" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">asyncio.run_coroutine_threadsafe(coro,loop)</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure>
<p style="user-select: auto;">向<code style="user-select: auto;">loop</code>指定的事件循环提交一个由<code style="user-select: auto;">coro</code>指定协程。线程安全。<br style="user-select: auto;">返回一个<code style="user-select: auto;">concurrent.futures.Future</code>对象，等待另一个线程返回结果。<br style="user-select: auto;">这个函数用于从<code style="user-select: auto;">当前线程</code>向<code style="user-select: auto;">运行事件循环的线程</code>提交<code style="user-select: auto;">协程(coroutine)</code>。<br style="user-select: auto;">例如：<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;"># Create a coroutine</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">coro = asyncio.sleep(<span class="number" style="user-select: auto;">1</span>, result=<span class="number" style="user-select: auto;">3</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;"># Submit the coroutine to a given loop</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">future = asyncio.run_coroutine_threadsafe(coro, loop)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;"># Wait for the result with an optional timeout argument</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">assert</span> future.result(timeout) == <span class="number" style="user-select: auto;">3</span></span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">如果<code style="user-select: auto;">协程</code>出现异常，返回的<code style="user-select: auto;">Future</code>会收到通知。返回的<code style="user-select: auto;">Future</code>也可以被用作取消事件循环中的任务：<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">9</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">try</span>:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    result = future.result(timeout)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">except</span> asyncio.TimeoutError:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    print(<span class="string" style="user-select: auto;">'The coroutine took too long, cancelling the task...'</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    future.cancel()</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">except</span> Exception <span class="keyword" style="user-select: auto;">as</span> exc:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    print(<span class="string" style="user-select: auto;">f'The coroutine raised an exception: <span class="subst" style="user-select: auto;">{exc!r}</span>'</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">else</span>:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    print(<span class="string" style="user-select: auto;">f'The coroutine returned: <span class="subst" style="user-select: auto;">{result!r}</span>'</span>)</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">可以参考<a href="https://docs.python.org/3/library/asyncio-dev.html#asyncio-multithreading" target="_blank" rel="noopener" style="user-select: auto;">并发与多线程</a>章节。<br style="user-select: auto;">与其他asyncio函数不同，该函数需要 <strong style="user-select: auto;">显式</strong> 传递<code style="user-select: auto;">loop</code>参数。<br style="user-select: auto;"><strong style="user-select: auto;">新增于Python 3.5.1</strong></p>
<h2 id="自查（Introspection）" style="user-select: auto;"><a href="#自查（Introspection）" class="headerlink" title="自查（Introspection）" style="user-select: auto;"></a>自查（Introspection）</h2><h3 id="current-task" style="user-select: auto;"><a href="#current-task" class="headerlink" title="current_task()" style="user-select: auto;"></a>current_task()</h3><figure class="highlight plain" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">asyncio.current_task(loop=None)</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure>
<p style="user-select: auto;">返回事件循环中正在运行的<code style="user-select: auto;">Task</code>实例，如果没有<code style="user-select: auto;">Task</code>在执行，则返回<code style="user-select: auto;">None</code>。<br style="user-select: auto;">如果<code style="user-select: auto;">loop</code>为<code style="user-select: auto;">None</code>,则使用<code style="user-select: auto;">get_running_loop()</code>获取当前事件循环。<br style="user-select: auto;"><strong style="user-select: auto;">新增于Python3.7</strong></p>
<h3 id="all-tasks" style="user-select: auto;"><a href="#all-tasks" class="headerlink" title="all_tasks()" style="user-select: auto;"></a>all_tasks()</h3><figure class="highlight plain" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">asyncio.all_tasks(loop=None)</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure>
<p style="user-select: auto;">返回事件循环中尚未运行结束的<code style="user-select: auto;">Task</code>对象集合。<br style="user-select: auto;">如果<code style="user-select: auto;">loop</code>为<code style="user-select: auto;">None</code>，则，使用<code style="user-select: auto;">get_running_loop()</code>获取当前事件循环。<br style="user-select: auto;"><strong style="user-select: auto;">新增于Python3.7</strong></p>
<h2 id="Task对象" style="user-select: auto;"><a href="#Task对象" class="headerlink" title="Task对象" style="user-select: auto;"></a>Task对象</h2><figure class="highlight plain" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">class asyncio.Task(coro,*,loop=None)</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure>
<p style="user-select: auto;">类似与<code style="user-select: auto;">Future</code>对象，用于执行Python协程。非线程安全。<br style="user-select: auto;"><code style="user-select: auto;">Tasks</code>用于在<code style="user-select: auto;">事件循环</code>中执行<code style="user-select: auto;">协程</code>。如果<code style="user-select: auto;">协程</code>等待一个<code style="user-select: auto;">Future</code>，那么<code style="user-select: auto;">Task</code>会暂停<code style="user-select: auto;">协程</code>的执行，直到<code style="user-select: auto;">Future</code>执行完成。当<code style="user-select: auto;">Future</code>完成时，<code style="user-select: auto;">协程</code>的执行会恢复。<br style="user-select: auto;">事件循环的 <em style="user-select: auto;">协作调度</em> 模式：一个事件循环同一时间只执行一个<code style="user-select: auto;">Task</code>。当这个<code style="user-select: auto;">Task</code>等待某个<code style="user-select: auto;">Future</code>返回时，事件循环执行其他的<code style="user-select: auto;">Task</code>、<code style="user-select: auto;">回调</code>或<code style="user-select: auto;">IO操作</code>。</p>
<p style="user-select: auto;">可以通过高层函数<code style="user-select: auto;">asyncio.create_task()</code>创建<code style="user-select: auto;">Task</code>，或者通过底层函数<code style="user-select: auto;">loop.create_task()</code>和<code style="user-select: auto;">ensure_future()</code>创建<code style="user-select: auto;">Task</code>。但是不建议直接实例化<code style="user-select: auto;">Task</code>对象。</p>
<p style="user-select: auto;">如果想要取消一个<code style="user-select: auto;">Task</code>的执行，可以使用<code style="user-select: auto;">cancel()</code>方法。调用<code style="user-select: auto;">cancel()</code>会引起<code style="user-select: auto;">Task</code>对象向被封装的<code style="user-select: auto;">协程</code>抛出<code style="user-select: auto;">CancelledError</code>异常。当取消行为发生时，如果<code style="user-select: auto;">协程</code>正在等待某个<code style="user-select: auto;">Future</code>对象执行，该<code style="user-select: auto;">Future</code>对象将被取消。</p>
<p style="user-select: auto;"><code style="user-select: auto;">cancelled()</code>方法用于检查某个<code style="user-select: auto;">Task</code>是否已被取消。如果<code style="user-select: auto;">Task</code>封装的<code style="user-select: auto;">协程</code>没有阻止<code style="user-select: auto;">CancelledError</code>异常，且<code style="user-select: auto;">Task</code>确实被取消了，则该方法返回<code style="user-select: auto;">True</code>。</p>
<p style="user-select: auto;"><code style="user-select: auto;">asyncio.Task</code>继承了<code style="user-select: auto;">Future</code>类中除<code style="user-select: auto;">Future.set_result()</code>和<code style="user-select: auto;">Future.set_exception()</code>以外的所有方法。</p>
<p style="user-select: auto;"><code style="user-select: auto;">Task</code>对象支持<code style="user-select: auto;">contextvars</code>模块：当一个<code style="user-select: auto;">Task</code>被创建的时候，它会复制当前的上下文，然后在复制的上下文副本中执行协程。</p>
<p style="user-select: auto;"><strong style="user-select: auto;">Python3.7中的变更</strong>：添加了对<code style="user-select: auto;">contextvars</code>模块的支持。</p>
<h3 id="cancel" style="user-select: auto;"><a href="#cancel" class="headerlink" title="cancel()" style="user-select: auto;"></a>cancel()</h3><p style="user-select: auto;">申请取消任务。<br style="user-select: auto;">将在下一个事件循环周期中将<code style="user-select: auto;">CancelledError</code>异常抛给封装在<code style="user-select: auto;">Task</code>中的协程。<br style="user-select: auto;">收到<code style="user-select: auto;">CancelledError</code>异常后，<code style="user-select: auto;">协程</code>有机会处理异常，甚至以<code style="user-select: auto;">try ...except CancelledError ...finally</code>来拒绝请求。因此，与<code style="user-select: auto;">Future.cancel()</code>不同，<code style="user-select: auto;">Task.cancel()</code>不能保证<code style="user-select: auto;">Task</code>一定被取消掉。当然，拒绝取消请求这种操作并不常见，而且很不提倡。</p>
<p style="user-select: auto;">以下例子可以说明协程如何拦截取消请求：<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">7</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">8</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">9</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">10</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">11</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">12</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">13</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">14</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">15</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">16</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">17</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">18</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">19</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">20</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">21</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">22</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">23</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">24</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">25</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">26</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">27</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">28</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">29</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">30</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">31</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">32</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">33</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">34</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">import</span> asyncio</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">cancel_me</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    print(<span class="string" style="user-select: auto;">'cancel_me(): before sleep'</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">try</span>:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="comment" style="user-select: auto;"># Wait for 1 hour</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">await</span> asyncio.sleep(<span class="number" style="user-select: auto;">3600</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">except</span> asyncio.CancelledError:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        print(<span class="string" style="user-select: auto;">'cancel_me(): cancel sleep'</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">raise</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">finally</span>:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        print(<span class="string" style="user-select: auto;">'cancel_me(): after sleep'</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">main</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;"># Create a "cancel_me" Task</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    task = asyncio.create_task(cancel_me())</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="comment" style="user-select: auto;"># Wait for 1 second</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">await</span> asyncio.sleep(<span class="number" style="user-select: auto;">1</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    task.cancel()</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">try</span>:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        <span class="keyword" style="user-select: auto;">await</span> task</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">except</span> asyncio.CancelledError:</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">        print(<span class="string" style="user-select: auto;">"main(): cancel_me is cancelled now"</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">asyncio.run(main())</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;"># Expected output:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;">#</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;">#     cancel_me(): before sleep</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;">#     cancel_me(): cancel sleep</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;">#     cancel_me(): after sleep</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="comment" style="user-select: auto;">#     main(): cancel_me is cancelled now</span></span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<h3 id="cancelled" style="user-select: auto;"><a href="#cancelled" class="headerlink" title="cancelled()" style="user-select: auto;"></a>cancelled()</h3><p style="user-select: auto;">如果<code style="user-select: auto;">Task</code>已经被取消，则返回<code style="user-select: auto;">True</code>。<br style="user-select: auto;">当取消请求通过<code style="user-select: auto;">cancel()</code>被提交，且<code style="user-select: auto;">Task</code>封装的<code style="user-select: auto;">协程</code>传播了抛给它的<code style="user-select: auto;">CancelledError</code>异常，则此<code style="user-select: auto;">Task</code>被取消。</p>
<h3 id="done" style="user-select: auto;"><a href="#done" class="headerlink" title="done()" style="user-select: auto;"></a>done()</h3><p style="user-select: auto;">如果<code style="user-select: auto;">Task</code>已完成，则返回<code style="user-select: auto;">True</code>。<br style="user-select: auto;"><code style="user-select: auto;">Task</code>完成有三种情况：</p>
<ul style="user-select: auto;">
<li style="user-select: auto;">封装的协程已返回</li>
<li style="user-select: auto;">封装的协程已抛出异常</li>
<li style="user-select: auto;"><code style="user-select: auto;">Task</code>被取消</li>
</ul>
<h3 id="result" style="user-select: auto;"><a href="#result" class="headerlink" title="result()" style="user-select: auto;"></a>result()</h3><p style="user-select: auto;">返回<code style="user-select: auto;">Task</code>的执行结果。<br style="user-select: auto;">如果<code style="user-select: auto;">Task</code>已经完成，则返回<code style="user-select: auto;">Task</code>封装的协程的执行结果（如果<code style="user-select: auto;">Task</code>封装的协程引发异常，则重新引发该异常）。<br style="user-select: auto;">如果<code style="user-select: auto;">Task</code>已经取消，则该方法引发<code style="user-select: auto;">CancelledError</code>异常。<br style="user-select: auto;">如果<code style="user-select: auto;">Task</code>的结果还不可用，该方法引发<code style="user-select: auto;">InvalidStateError</code>异常。</p>
<h3 id="exception" style="user-select: auto;"><a href="#exception" class="headerlink" title="exception()" style="user-select: auto;"></a>exception()</h3><p style="user-select: auto;">返回<code style="user-select: auto;">Task</code>的异常。<br style="user-select: auto;">如果封装的协程引发了异常，则返回此异常。如果封装的协程执行正常，则返回<code style="user-select: auto;">None</code>。<br style="user-select: auto;">如果<code style="user-select: auto;">Task</code>已被取消，则引发<code style="user-select: auto;">CancelledError</code>异常。<br style="user-select: auto;">如果<code style="user-select: auto;">Task</code>尚未完成，则引发<code style="user-select: auto;">InvalidStateError</code>异常。</p>
<h3 id="add-done-callback" style="user-select: auto;"><a href="#add-done-callback" class="headerlink" title="add_done_callback()" style="user-select: auto;"></a>add_done_callback()</h3><p style="user-select: auto;">添加一个回调函数，在<code style="user-select: auto;">Task</code>完成后执行。<br style="user-select: auto;">这个方法只应用在基于回调的底层编程中。<br style="user-select: auto;">具体细节可以参考<a href="https://docs.python.org/3/library/asyncio-future.html#asyncio.Future.remove_done_callback" target="_blank" rel="noopener" style="user-select: auto;"><code style="user-select: auto;">Future.remove_done_callback()</code></a></p>
<h3 id="get-stack-limit-None" style="user-select: auto;"><a href="#get-stack-limit-None" class="headerlink" title="get_stack(* ,limit=None)" style="user-select: auto;"></a>get_stack(* ,limit=None)</h3><p style="user-select: auto;">返回此<code style="user-select: auto;">Task</code>的堆栈帧列表。</p>
<ul style="user-select: auto;">
<li style="user-select: auto;">如果封装的协程未完成，此方法返回它暂停位置的堆栈。</li>
<li style="user-select: auto;">如果封装的协程已经完成或已被取消，此方法返回一个空的列表。</li>
<li style="user-select: auto;">如果封装的协程因异常而结束，此方法返回异常回溯列表。</li>
</ul>
<p style="user-select: auto;">帧的顺序总是 <strong style="user-select: auto;">由旧到新</strong>。<br style="user-select: auto;">暂停中的协程只返回一个堆栈帧。<br style="user-select: auto;">可选参数<code style="user-select: auto;">limit</code>用于限定返回帧的最大数目。默认情况下，所有有效的帧都会返回。<br style="user-select: auto;">在返回堆栈和返回异常回溯时，列表的顺序会有所不同：</p>
<ul style="user-select: auto;">
<li style="user-select: auto;">最新的堆栈帧会被返回</li>
<li style="user-select: auto;">最老的回溯帧会被返回（这和异常回溯模块的机制有关）</li>
</ul>
<h3 id="print-stack-limit-None-file-None" style="user-select: auto;"><a href="#print-stack-limit-None-file-None" class="headerlink" title="print_stack(* ,limit=None,file=None)" style="user-select: auto;"></a>print_stack(* ,limit=None,file=None)</h3><p style="user-select: auto;">打印<code style="user-select: auto;">Task</code>的栈帧或异常回溯。<br style="user-select: auto;">此方法用于输出由<code style="user-select: auto;">get_stack()</code>取回的帧列表，输出形式类似于<code style="user-select: auto;">回溯(traceback)模块</code><br style="user-select: auto;"><code style="user-select: auto;">limit</code>参数会直接传递给<code style="user-select: auto;">get_stack()</code>。<br style="user-select: auto;"><code style="user-select: auto;">file</code>参数指定输出的I/O流，默认为<code style="user-select: auto;">sys.stderr</code>。</p>
<h3 id="classmethod-all-tasks-loop-None" style="user-select: auto;"><a href="#classmethod-all-tasks-loop-None" class="headerlink" title="classmethod all_tasks(loop=None)" style="user-select: auto;"></a>classmethod all_tasks(loop=None)</h3><p style="user-select: auto;">返回一个事件循环上所有任务的集合。<br style="user-select: auto;">默认情况下，当前事件循环上所有的任务都会被返回。如果<code style="user-select: auto;">loop</code>参数为’None’，则通过<code style="user-select: auto;">get_event_loop()</code>方法获取当前事件循环。</p>
<p style="user-select: auto;">此方法将在Python3.9中被移除，所以不建议使用。可以使用<code style="user-select: auto;">asyncio.all_tasks()</code>代替。</p>
<h3 id="calssmethod-current-task-loop-None" style="user-select: auto;"><a href="#calssmethod-current-task-loop-None" class="headerlink" title="calssmethod current_task(loop=None)" style="user-select: auto;"></a>calssmethod current_task(loop=None)</h3><p style="user-select: auto;">返回当前正在运行的<code style="user-select: auto;">Task</code>或<code style="user-select: auto;">None</code>。<br style="user-select: auto;">如果<code style="user-select: auto;">loop</code>参数为’None’，则通过<code style="user-select: auto;">get_event_loop()</code>方法获取当前事件循环。<br style="user-select: auto;">此方法将在Python3.9中被移除，所以不建议使用。可以使用<code style="user-select: auto;">asyncio.current_task()</code>代替。</p>
<h2 id="基于生成器的协程（Generator-based-Coroutines）" style="user-select: auto;"><a href="#基于生成器的协程（Generator-based-Coroutines）" class="headerlink" title="基于生成器的协程（Generator-based Coroutines）" style="user-select: auto;"></a>基于生成器的协程（Generator-based Coroutines）</h2><p style="user-select: auto;"><strong style="user-select: auto;">提示</strong>：对基于生成器的协程的支持将在Python3.10中移除，不建议使用。<br style="user-select: auto;">基于生成器的协程是早期的异步实现方式，出现在<code style="user-select: auto;">async/await</code>语法之前，使用<code style="user-select: auto;">yield from</code>表达式等待<code style="user-select: auto;">Future</code>或其他协程。<br style="user-select: auto;">基于生成器的协程应该用<a href="mailto:`@asyncio.coroutine" target="_blank" rel="noopener" style="user-select: auto;">`@asyncio.coroutine</a>`来修饰，尽管这不是强制的。</p>
<h3 id="asyncio-coroutine" style="user-select: auto;"><a href="#asyncio-coroutine" class="headerlink" title="@asyncio.coroutine" style="user-select: auto;"></a>@asyncio.coroutine</h3><p style="user-select: auto;">基于生成器的协程的修饰器。<br style="user-select: auto;">这个修饰器能使传统的<code style="user-select: auto;">基于生成器的协程</code>与<code style="user-select: auto;">async/await</code>语法兼容：<br style="user-select: auto;"></p><figure class="highlight python" style="user-select: auto;"><table style="user-select: auto;"><tbody style="user-select: auto;"><tr style="user-select: auto;"><td class="gutter" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;">1</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">2</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">3</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">4</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">5</span><br style="user-select: auto;"><span class="line" style="user-select: auto;">6</span><br style="user-select: auto;"></pre></td><td class="code" style="user-select: auto;"><pre style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="meta" style="user-select: auto;">@asyncio.coroutine</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">old_style_coroutine</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">yield</span> <span class="keyword" style="user-select: auto;">from</span> asyncio.sleep(<span class="number" style="user-select: auto;">1</span>)</span><br style="user-select: auto;"><span class="line" style="user-select: auto;"></span><br style="user-select: auto;"><span class="line" style="user-select: auto;"><span class="keyword" style="user-select: auto;">async</span> <span class="function" style="user-select: auto;"><span class="keyword" style="user-select: auto;">def</span> <span class="title" style="user-select: auto;">main</span><span class="params" style="user-select: auto;">()</span>:</span></span><br style="user-select: auto;"><span class="line" style="user-select: auto;">    <span class="keyword" style="user-select: auto;">await</span> old_style_coroutine()</span><br style="user-select: auto;"></pre></td></tr></tbody></table></figure><p style="user-select: auto;"></p>
<p style="user-select: auto;">此修饰器将在Python3.10中被移除，所以不建议再使用。<br style="user-select: auto;">此修饰器不能用于<code style="user-select: auto;">async def</code>的协程中。</p>
<h3 id="asyncio-iscoroutine-obj" style="user-select: auto;"><a href="#asyncio-iscoroutine-obj" class="headerlink" title="asyncio.iscoroutine(obj)" style="user-select: auto;"></a>asyncio.iscoroutine(obj)</h3><p style="user-select: auto;">如果<code style="user-select: auto;">obj</code>对象是一个<code style="user-select: auto;">coroutine</code>对象，则返回<code style="user-select: auto;">True</code>。<br style="user-select: auto;">此方法与<code style="user-select: auto;">inspect.iscoroutine()</code>不同，因为它对基于生成器的协程也返回<code style="user-select: auto;">True</code>。</p>
<h3 id="asyncio-iscoroutinefunction-func" style="user-select: auto;"><a href="#asyncio-iscoroutinefunction-func" class="headerlink" title="asyncio.iscoroutinefunction(func)" style="user-select: auto;"></a>asyncio.iscoroutinefunction(func)</h3><p style="user-select: auto;">如果<code style="user-select: auto;">func</code>是一个<code style="user-select: auto;">coroutine</code>方法，则返回<code style="user-select: auto;">True</code>。<br style="user-select: auto;">此方法<code style="user-select: auto;">inspect.iscoroutinefunction()</code>不同，因为它对用<code style="user-select: auto;">@coroutine</code>修饰的基于生成器的协程也返回<code style="user-select: auto;">True</code>。</p>
<p style="user-select: auto;"><script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js" style="user-select: auto;"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js" style="user-select: auto;"></script><textarea id="flowchart-0-code" style="display: none; user-select: auto;">s=&gt;start: 开始
op1=&gt;operation: 打印“hello”
op2=&gt;operation: 沉睡1秒
op3=&gt;operation: 打印“world”
e=&gt;end: 结束

s(right)-&gt;op1-&gt;op2-&gt;op3(right)-&gt;e</textarea><textarea id="flowchart-0-options" style="display: none; user-select: auto;">{"scale":1,"line-width":2,"line-length":50,"text-margin":10,"font-size":12}</textarea><script style="user-select: auto;">  var code = document.getElementById("flowchart-0-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("flowchart-0-options").value));  var diagram = flowchart.parse(code);  diagram.drawSVG("flowchart-0", options);</script></p>


    </div>